#!/bin/bash

set -euo pipefail

repo_url="https://github.com/didi64/Programmieren_ZTel_23Ta"
root="${HOME}/work"
repo_url="$root/.src"
nb_dir="${root}/notebooks"
contents="${repo_url}/contents.txt"

is_number='^[0-9]+$'

options=""
HELP=$(cat <<EOF

usage:
======
1) update <number>
   updates src and copies files of lesson <number> to  work/notebooks
       
2) update
   updates src
 
3) update <file1> [<file2> ...]
   updates and copies files to work/notebooks
 
in case of errors: try       
       
4) update -f
   forces updates of src       

if this fails, type call
get_src

EOF
)

printf "$HELP"

process_file () {
    find "$repo_url" -type d -name $1 -exec cp -ri {} "$nb_dir" \;
    find "$repo_url" -type f -name $1 -exec cp -i {} "$nb_dir" \;
}

pull () {
    git -C "$repo_url" pull
    # find "$repo_url" -type f -name "*.ipynb" -exec chmod 444 {} \;
}

if [[ $# -ge 1 ]] && [[ "$1" == "-f" ]]; then
    git -C "$repo_url"  reset --hard HEAD
fi

pull

# echo "args: $@"
for item in "$@"; do
    if [[ $item =~ $is_number ]] ; then
        files=$(sed -n "s/^${item}:\(.*\)/\1/p" "$CONTENTS")
        for file in $files; do
            process_file $file
        done
    else
        process_file $item
    fi  
done